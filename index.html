<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Card Counting Trainer</title>

  <!-- PWA hooks (keep if you're hosting / packaging) -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">

  <style>
    :root{
      --bg:#0b1220; --panel:#111b2e; --text:#e7eefc; --muted:#a9b6d3;
      --accent:#4cc9f0; --good:#49d17c; --bad:#ff5d5d; --warn:#ffd166;
      --border:rgba(255,255,255,.10);
      --shadow: 0 12px 34px rgba(0,0,0,.38);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:radial-gradient(1200px 700px at 20% 0%, #1a2b57 0%, var(--bg) 55%, #070b14 100%);
      overflow:hidden; /* ‚úÖ no scrolling */
      -webkit-tap-highlight-color: transparent;
    }

    /* ===== Top bar ===== */
    header{
      position:relative;
      height:64px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      background:rgba(10,16,32,.62);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:190px}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background:linear-gradient(135deg, rgba(76,201,240,.95), rgba(73,209,124,.9));
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .title{line-height:1.1}
    .title b{display:block; font-size:14px; letter-spacing:.2px}
    .title span{display:block; font-size:11px; color:var(--muted)}
    .topRight{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(255,255,255,.04);
      font-size:13px;
      white-space:nowrap;
    }
    .pill b{color:var(--accent)}
    .btn{
      cursor:pointer; user-select:none;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:9px 12px; border-radius:14px;
      font-weight:900; font-size:13px;
      transition:.14s transform,.14s background,.14s border;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.07)}
    .btn:active{transform:translateY(0px)}
    .btn.primary{background: rgba(76,201,240,.16); border-color: rgba(76,201,240,.35)}
    .btn.good{background: rgba(73,209,124,.14); border-color: rgba(73,209,124,.35)}
    .btn.bad{background: rgba(255,93,93,.13); border-color: rgba(255,93,93,.35)}
    .btn.warn{background: rgba(255,209,102,.14); border-color: rgba(255,209,102,.35)}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none}

    /* ===== App layout (no scroll) ===== */
    .app{
      height: calc(100vh - 64px);
      display:grid;
      place-items:center;
      padding:12px;
    }
    .frame{
      width:min(1040px, 100%);
      height:100%;
      display:grid;
      grid-template-rows: auto 1fr auto;
      gap:12px;
    }

    /* ===== Welcome screen ===== */
    .welcome{
      height:100%;
      display:grid;
      place-items:center;
    }
    .welcomeCard{
      width:min(820px, 100%);
      border:1px solid var(--border);
      border-radius: 18px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      padding:16px;
    }
    .welcomeTop{
      display:flex; align-items:center; gap:12px;
      margin-bottom:10px;
    }
    .welcomeTop h1{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
    }
    .sub{color:var(--muted); font-size:13px; margin-top:4px; line-height:1.4}
    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 860px){ .split{grid-template-columns:1fr} }
    .box{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background:rgba(0,0,0,.16);
      padding:12px;
    }
    .box h3{margin:0 0 8px 0; font-size:13px; color:var(--muted); letter-spacing:.2px}
    .list{margin:0; padding-left:18px; color:var(--muted); font-size:13px}
    .list li{margin:6px 0}
    .welcomeActions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}

    /* ===== Main table screen ===== */
    .table{
      height:100%;
      display:grid;
      grid-template-rows: auto auto 1fr auto;
      gap:12px;
    }

    .tableTopRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .msg{
      font-size:18px;
      font-weight:1000;
      letter-spacing:.2px;
      margin:0;
    }
    .muted{color:var(--muted); font-size:12px}

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 860px){ .controls{grid-template-columns:1fr} }
    label{font-size:12px; color:var(--muted)}
    select, input[type="number"]{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
    }
    select:focus, input:focus{border-color: rgba(76,201,240,.5)}

    .actions{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }

    .hands{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      height:100%;
      min-height:0;
    }
    @media (max-width: 860px){ .hands{grid-template-columns:1fr} }

    .handBox{
      height:100%;
      display:grid;
      grid-template-rows: auto 1fr;
      min-height:0;
    }
    .handHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .badge{
      padding:6px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      white-space:nowrap;
    }
    .cards{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-content:flex-start;
      overflow:hidden; /* keep flat */
    }
    .card{
      width:72px; height:98px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      display:grid; place-items:center;
      position:relative;
      box-shadow: 0 10px 20px rgba(0,0,0,.22);
      font-weight:900;
    }
    .card.red{border-color: rgba(255,93,93,.25)}
    .card .corner{position:absolute; top:8px; left:8px; font-size:12px; opacity:.95}
    .card .corner2{position:absolute; bottom:8px; right:8px; font-size:12px; opacity:.95; transform:rotate(180deg)}
    .card .rank{font-size:16px}
    .card .suit{font-size:20px}
    .card.red .suit{color: var(--bad)}
    .card.black .suit{color:#dbe7ff}
    .hole{
      background:linear-gradient(180deg, rgba(76,201,240,.12), rgba(0,0,0,.16)) !important;
    }

    .footerRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .status.good{color:var(--good)}
    .status.bad{color:var(--bad)}
    .status.warn{color:var(--warn)}

    /* ===== Modal ===== */
    .modalBackdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
      z-index:200;
      padding:16px;
    }
    .modalBackdrop.show{display:flex; align-items:center; justify-content:center;}
    .modal{
      width:min(940px, 100%);
      max-height: 86vh;
      overflow:auto;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(17,27,46,.98), rgba(9,13,24,.98));
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      padding:14px;
    }
    .modalHeader{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      padding-bottom:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      margin-bottom:10px;
    }
    .modalHeader h2{margin:0; font-size:18px}
    .modalHeader p{margin:4px 0 0 0; color:var(--muted); font-size:13px}
    .modalBody{display:grid; gap:12px}
    .step{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background:rgba(0,0,0,.14);
      padding:12px;
    }
    .step h4{margin:0 0 6px 0; font-size:14px}
    .step ul{margin:8px 0 0 18px; color:var(--text)}
    .step li{margin:6px 0; color:var(--muted)}
    .callout{
      border-left:4px solid rgba(76,201,240,.7);
      padding:10px 12px;
      border-radius:12px;
      background:rgba(76,201,240,.08);
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      background:rgba(0,0,0,.25);
      padding:2px 6px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:10px;
      color:var(--text);
      font-size:12px;
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div class="title">
      <b>Card Counting Trainer</b>
      <span>Blackjack + Hi-Lo (RC / TC)</span>
    </div>
  </div>

  <div class="topRight">
    <button class="btn primary" id="btnHow">How to Count</button>
    <button class="btn" id="btnSettings">Settings</button>

    <div class="pill">Bank: <b id="bank">$1000</b></div>
    <div class="pill">Running: <b id="rcTop">0</b></div>
    <div class="pill">True: <b id="tcTop">0.0</b></div>
  </div>
</header>

<div class="app">
  <div class="frame">
    <!-- WELCOME -->
    <section id="screenWelcome" class="welcome">
      <div class="welcomeCard">
        <div class="welcomeTop">
          <div class="logo"></div>
          <div>
            <h1>Welcome to CountTrainer</h1>
            <div class="sub">
              Practice Hi-Lo card counting offline. Start in Beginner (counts shown), then hide them and self-test with Count Checks.
            </div>
          </div>
        </div>

        <div class="split">
          <div class="box">
            <h3>What you‚Äôll practice</h3>
            <ul class="list">
              <li><b>Running Count (RC)</b> using Hi-Lo (+1 / 0 / ‚àí1)</li>
              <li><b>Decks remaining</b> intuition</li>
              <li><b>True Count (TC)</b> = RC √∑ decks remaining</li>
              <li><b>Bet sizing</b> based on TC (optional)</li>
            </ul>
          </div>
          <div class="box">
            <h3>Quick controls</h3>
            <ul class="list">
              <li>Use <b>Deal / Hit / Stand / Double</b></li>
              <li>Use <b>Count Check</b> to grade your RC/TC</li>
              <li>Keep it ‚Äúflat‚Äù: this app is designed to <b>not scroll</b></li>
            </ul>
          </div>
        </div>

        <div class="welcomeActions">
          <button class="btn primary" id="btnStart">Start Training</button>
          <button class="btn" id="btnReset">Reset Bank/Stats</button>
          <span class="muted">Tip: turn on Airplane Mode ‚Äî it still works.</span>
        </div>
      </div>
    </section>

    <!-- TABLE (FLAT SCREEN) -->
    <section id="screenTable" class="table" style="display:none;">
      <div class="box">
        <div class="tableTopRow">
          <div>
            <p class="msg" id="msg">Press Deal to start a shoe.</p>
            <div class="muted" id="subMsg">Dealer stands on 17 ‚Ä¢ no splits ‚Ä¢ double on first decision</div>
          </div>
          <div class="actions">
            <button class="btn primary" id="btnDeal">Deal</button>
            <button class="btn" id="btnHit" disabled>Hit</button>
            <button class="btn" id="btnStand" disabled>Stand</button>
            <button class="btn warn" id="btnDouble" disabled>Double</button>
            <button class="btn good" id="btnCountCheck">Count Check</button>
          </div>
        </div>
      </div>

      <!-- minimalist controls row -->
      <div class="controls">
        <div class="box">
          <label>Count check frequency</label>
          <select id="checkFreq">
            <option value="everyHand" selected>Every hand</option>
            <option value="random">Random (about 1/3 hands)</option>
            <option value="manual">Manual only</option>
          </select>
          <div class="muted" style="margin-top:6px">Prompts you to enter your count.</div>
        </div>

        <div class="box">
          <label>Base unit amount ($)</label>
          <input id="unit" type="number" min="1" step="1" value="50" />
          <div class="muted" style="margin-top:6px">Used for bet sizing & grading.</div>
        </div>

        <div class="box">
          <label>Bet units</label>
          <select id="betUnits">
            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
            <option value="4">4</option><option value="6">6</option><option value="8">8</option>
            <option value="10">10</option><option value="12">12</option>
          </select>
          <div class="muted" style="margin-top:6px">Trainer can grade this (Settings).</div>
        </div>
      </div>

      <!-- hands -->
      <div class="hands">
        <div class="box handBox">
          <div class="handHeader">
            <b>Dealer</b>
            <span class="badge">Total: <b id="dTotal">‚Äî</b></span>
          </div>
          <div class="cards" id="dealerCards"></div>
        </div>

        <div class="box handBox">
          <div class="handHeader">
            <b>You</b>
            <span class="badge">Total: <b id="pTotal">‚Äî</b></span>
          </div>
          <div class="cards" id="playerCards"></div>
        </div>
      </div>

      <!-- bottom row -->
      <div class="box">
        <div class="footerRow">
          <div class="badge">Hand Bet: <b id="handBetLabel">$0</b></div>
          <div class="badge">Suggested Bet: <b id="suggestBet">‚Äî</b></div>
          <div class="badge">Shoe: <b id="shoeInfo">‚Äî</b></div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- HOW TO COUNT modal -->
<div class="modalBackdrop" id="helpBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="How to count cards">
    <div class="modalHeader">
      <div>
        <h2>How to Count Cards (Hi-Lo) ‚Äî Full Process</h2>
        <p>Close with <span class="mono">Esc</span> or tap outside.</p>
      </div>
      <button class="btn" id="btnCloseHelp">Close</button>
    </div>

    <div class="modalBody">
      <div class="callout">
        <b>Goal:</b> Keep a <b>Running Count</b> of what‚Äôs dealt. Convert to a <b>True Count</b> using decks remaining.
        Bet more when TC is high.
      </div>

      <div class="step">
        <h4>1) Memorize values</h4>
        <ul>
          <li><b>2‚Äì6</b> ‚Üí <span class="mono">+1</span></li>
          <li><b>7‚Äì9</b> ‚Üí <span class="mono">0</span></li>
          <li><b>10‚ÄìA</b> ‚Üí <span class="mono">‚àí1</span></li>
        </ul>
      </div>

      <div class="step">
        <h4>2) Running Count (RC)</h4>
        <ul>
          <li>Start RC at <span class="mono">0</span> after a shuffle.</li>
          <li>Update RC for every <b>exposed</b> card: your cards, dealer upcard, hits, and dealer hole card when revealed.</li>
        </ul>
      </div>

      <div class="step">
        <h4>3) True Count (TC)</h4>
        <div class="callout"><b>TC</b> = <span class="mono">RC √∑ Decks Remaining</span></div>
        <ul>
          <li>RC +8 with 4 decks left ‚Üí TC ‚âà +2</li>
          <li>RC +8 with 2 decks left ‚Üí TC ‚âà +4 (stronger)</li>
        </ul>
      </div>

      <div class="step">
        <h4>4) Bet ramp (simple trainer version)</h4>
        <ul>
          <li>TC ‚â§ 0 ‚Üí 1u</li>
          <li>TC ~ 1 ‚Üí 2u</li>
          <li>TC ~ 2 ‚Üí 4u</li>
          <li>TC ~ 3 ‚Üí 8u</li>
          <li>TC ‚â• 4 ‚Üí 12u</li>
        </ul>
      </div>

      <div class="step">
        <h4>Practice routine</h4>
        <ul>
          <li>Start with counts shown (Settings), then hide them.</li>
          <li>Use <b>Count Check</b> to enter your RC/TC and get graded.</li>
          <li>Repeat until you can keep RC without thinking.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS modal -->
<div class="modalBackdrop" id="settingsBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Settings">
    <div class="modalHeader">
      <div>
        <h2>Settings</h2>
        <p>These don‚Äôt clutter the main table screen.</p>
      </div>
      <button class="btn" id="btnCloseSettings">Close</button>
    </div>

    <div class="modalBody">
      <div class="step">
        <h4>Trainer display</h4>
        <div class="callout">
          Turn these off to simulate real play. You can still use Count Check to test yourself.
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
          <label class="box" style="display:flex;gap:10px;align-items:center;cursor:pointer">
            <input type="checkbox" id="showRC" checked style="transform:scale(1.2)"/>
            <div>
              <b>Show Running Count</b>
              <div class="muted">Shows RC in the top bar.</div>
            </div>
          </label>
          <label class="box" style="display:flex;gap:10px;align-items:center;cursor:pointer">
            <input type="checkbox" id="showTC" checked style="transform:scale(1.2)"/>
            <div>
              <b>Show True Count</b>
              <div class="muted">Shows TC in the top bar.</div>
            </div>
          </label>
        </div>
      </div>

      <div class="step">
        <h4>Shoe behavior</h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
          <div>
            <label>Decks in shoe</label>
            <select id="decks">
              <option>1</option><option>2</option><option>4</option><option selected>6</option><option>8</option>
            </select>
          </div>
          <div>
            <label>Penetration (reshuffle point)</label>
            <select id="pen">
              <option value="0.5">50%</option>
              <option value="0.6">60%</option>
              <option value="0.65">65%</option>
              <option value="0.7">70%</option>
              <option value="0.75" selected>75%</option>
              <option value="0.8">80%</option>
              <option value="0.85">85%</option>
            </select>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
          <div>
            <label>Deal speed (ms)</label>
            <select id="speed">
              <option value="0">Instant</option>
              <option value="220">Fast</option>
              <option value="420" selected>Normal</option>
              <option value="700">Slow</option>
            </select>
          </div>
          <label class="box" style="display:flex;gap:10px;align-items:center;cursor:pointer">
            <input type="checkbox" id="autoHints" checked style="transform:scale(1.2)"/>
            <div>
              <b>Show Suggested Bet</b>
              <div class="muted">Displays trainer ramp suggestion.</div>
            </div>
          </label>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <button class="btn warn" id="btnShuffle">Shuffle Now</button>
          <button class="btn bad" id="btnWipe">Reset Bank/Stats</button>
          <span class="muted">Saves automatically.</span>
        </div>
      </div>

      <div class="step">
        <h4>Count Check</h4>
        <div class="callout">
          Press <b>Count Check</b> on the table screen to enter your RC/TC and get graded.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- COUNT CHECK modal -->
<div class="modalBackdrop" id="countBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Count check">
    <div class="modalHeader">
      <div>
        <h2>Count Check</h2>
        <p>Enter what you think the counts are right now.</p>
      </div>
      <button class="btn" id="btnCloseCount">Close</button>
    </div>

    <div class="modalBody">
      <div class="step">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label>Your Running Count</label>
            <input id="inpRC" type="number" step="1" value="0" />
          </div>
          <div>
            <label>Your True Count (optional)</label>
            <input id="inpTC" type="number" step="0.1" value="" placeholder="leave blank if unsure"/>
          </div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px">
          <button class="btn good" id="btnSubmitCount">Submit</button>
          <span class="muted" id="countFeedback"></span>
        </div>
      </div>

      <div class="callout">
        Tip: If you hide RC/TC in Settings, Count Check becomes your ‚Äúanswer key‚Äù.
      </div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   Flat-screen Blackjack Count Trainer (single file)
   - Welcome screen -> Table screen
   - No scrolling (viewport-locked)
   - Popups: How-to, Settings, Count Check
   - Auto-save bank/state via localStorage
========================================================= */

const $ = (sel, el=document) => el.querySelector(sel);

const SUITS = [
  {sym:"‚ô†", color:"black"},
  {sym:"‚ô•", color:"red"},
  {sym:"‚ô¶", color:"red"},
  {sym:"‚ô£", color:"black"},
];
const RANKS = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
const STORAGE_KEY = "counttrainer_flat_v1";

function money(n){
  const sign = n < 0 ? "-" : "";
  const abs = Math.abs(Math.round(n));
  return sign + "$" + abs.toString();
}
function clampInt(v, min=0){
  v = Math.floor(Number(v||0));
  if(!isFinite(v)) v = 0;
  return Math.max(min, v);
}
function clampFloat(v, min=0){
  v = Number(v||0);
  if(!isFinite(v)) v = 0;
  return Math.max(min, v);
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}
function delay(ms){ return new Promise(res=>setTimeout(res, ms)); }

/* Hi-Lo value */
function hiLoValue(rank){
  if(rank === "A" || rank === "K" || rank === "Q" || rank === "J" || rank === "10") return -1;
  const n = Number(rank);
  if(n >= 2 && n <= 6) return +1;
  if(n >= 7 && n <= 9) return 0;
  return 0;
}

/* Blackjack value */
function bjCardValue(rank){
  if(rank === "A") return 11;
  if(["K","Q","J","10"].includes(rank)) return 10;
  return Number(rank);
}
function bjHandValue(cards){
  let total = 0, aces = 0;
  for(const c of cards){
    total += bjCardValue(c.rank);
    if(c.rank === "A") aces++;
  }
  while(total > 21 && aces > 0){ total -= 10; aces--; }
  return total;
}
function isBlackjack(cards){
  return cards.length === 2 && bjHandValue(cards) === 21;
}

/* State */
let state = {
  // screens
  started: false,

  // trainer
  bank: 1000,
  showRC: true,
  showTC: true,
  autoHints: true,

  // shoe settings
  decks: 6,
  pen: 0.75,
  speed: 420,

  // shoe
  shoe: [],
  dealt: 0,
  runningCount: 0,

  // hand
  phase: "idle", // idle|player|dealer|done
  player: [],
  dealer: [],
  holeHidden: true,
  canDouble: false,
  handBet: 0
};

function autoSave(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){}
}
function load(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  try{
    const obj = JSON.parse(raw);
    if(obj && typeof obj === "object") state = {...state, ...obj};
  }catch(e){}
}
function resetAll(){
  state.started = false;
  state.bank = 1000;
  state.runningCount = 0;
  state.dealt = 0;
  state.player = [];
  state.dealer = [];
  state.phase = "idle";
  state.holeHidden = true;
  state.canDouble = false;
  state.handBet = 0;
  buildNewShoe(true);
  renderAll();
}

/* Shoe */
function shoeSize(){ return state.decks * 52; }
function cardsRemaining(){ return Math.max(0, shoeSize() - state.dealt); }
function decksRemaining(){ return cardsRemaining() / 52; }
function penetrationReached(){ return state.dealt >= Math.floor(state.pen * shoeSize()); }
function trueCount(){
  const dr = decksRemaining();
  if(dr <= 0.25) return state.runningCount;
  return state.runningCount / dr;
}
function buildNewShoe(silent=false){
  state.shoe = [];
  for(let d=0; d<state.decks; d++){
    for(const s of SUITS){
      for(const r of RANKS){
        state.shoe.push({rank:r, suit:s.sym, color:s.color});
      }
    }
  }
  shuffle(state.shoe);
  state.dealt = 0;
  state.runningCount = 0;
  if(!silent){
    setMsg("New shoe shuffled. RC reset to 0.", "Press Deal to start.");
  }
}
function drawOne(){
  if(state.shoe.length === 0 || cardsRemaining() === 0) buildNewShoe();
  const c = state.shoe.pop();
  state.dealt++;
  state.runningCount += hiLoValue(c.rank);
  return c;
}

/* Bet suggestion */
function suggestedUnits(tc){
  if(tc <= 0.5) return 1;
  if(tc <= 1.5) return 2;
  if(tc <= 2.5) return 4;
  if(tc <= 3.5) return 8;
  return 12;
}

/* UI helpers */
function setMsg(main, sub=""){
  $("#msg").textContent = main;
  $("#subMsg").textContent = sub;
}
function cardEl(c, hidden=false){
  const div = document.createElement("div");
  div.className = `card ${c.color}`;
  if(hidden){
    div.classList.add("hole");
    div.innerHTML = `<div class="corner">üÇ†</div><div class="suit">‚óÜ</div><div class="corner2">üÇ†</div>`;
  }else{
    div.innerHTML = `
      <div class="corner">${c.rank}${c.suit}</div>
      <div style="text-align:center">
        <div class="rank">${c.rank}</div>
        <div class="suit">${c.suit}</div>
      </div>
      <div class="corner2">${c.rank}${c.suit}</div>
    `;
  }
  return div;
}
function renderHands(){
  const d = $("#dealerCards"), p = $("#playerCards");
  d.innerHTML = ""; p.innerHTML = "";

  state.dealer.forEach((c,i)=>{
    const hide = state.holeHidden && i===1 && (state.phase==="player" || state.phase==="dealer");
    d.appendChild(cardEl(c, hide));
  });
  state.player.forEach(c => p.appendChild(cardEl(c,false)));

  $("#dTotal").textContent =
    (state.holeHidden && (state.phase==="player"||state.phase==="dealer"))
      ? "?"
      : (state.dealer.length ? bjHandValue(state.dealer) : "‚Äî");
  $("#pTotal").textContent = state.player.length ? bjHandValue(state.player) : "‚Äî";
}
function renderTop(){
  $("#bank").textContent = money(state.bank);
  $("#rcTop").textContent = state.showRC ? String(state.runningCount) : "‚Äî";
  $("#tcTop").textContent = state.showTC ? trueCount().toFixed(1) : "‚Äî";
}
function renderFooter(){
  const unit = clampInt($("#unit").value, 1);
  const chosenU = Number($("#betUnits").value);
  $("#handBetLabel").textContent = money(chosenU * unit);

  const tc = trueCount();
  const su = suggestedUnits(tc);
  $("#suggestBet").textContent = state.autoHints ? `${su}u = ${money(su*unit)}` : "‚Äî";

  const remain = cardsRemaining();
  $("#shoeInfo").textContent = penetrationReached()
    ? `Cut reached ‚Ä¢ ${remain} left`
    : `${remain} cards left`;
}
function setButtons(){
  const inPlay = state.phase === "player";
  const dealerPlay = state.phase === "dealer";
  $("#btnDeal").disabled = inPlay || dealerPlay;
  $("#btnHit").disabled = !inPlay;
  $("#btnStand").disabled = !inPlay;
  $("#btnDouble").disabled = !(inPlay && state.canDouble);
}
function showScreen(which){
  const w = $("#screenWelcome"), t = $("#screenTable");
  if(which === "welcome"){
    w.style.display = "grid";
    t.style.display = "none";
  }else{
    w.style.display = "none";
    t.style.display = "grid";
  }
}
function renderSettingsUI(){
  $("#showRC").checked = state.showRC;
  $("#showTC").checked = state.showTC;
  $("#autoHints").checked = state.autoHints;
  $("#decks").value = String(state.decks);
  $("#pen").value = String(state.pen);
  $("#speed").value = String(state.speed);
}
function renderAll(){
  // screen
  showScreen(state.started ? "table" : "welcome");

  // UI
  renderTop();
  renderHands();
  renderFooter();
  setButtons();
  renderSettingsUI();

  autoSave(); // ‚úÖ persist everything continuously
}

/* Modals */
function openModal(id){
  const el = $(id);
  el.classList.add("show");
  el.setAttribute("aria-hidden", "false");
}
function closeModal(id){
  const el = $(id);
  el.classList.remove("show");
  el.setAttribute("aria-hidden", "true");
}
function wireModal(backdropId, closeBtnId){
  const b = $(backdropId);
  b.addEventListener("click", (e)=>{ if(e.target === b) closeModal(backdropId); });
  $(closeBtnId).addEventListener("click", ()=> closeModal(backdropId));
}

/* Count check grading */
function gradeCountSubmission(){
  const userRC = Math.trunc(Number($("#inpRC").value));
  const tcRaw = $("#inpTC").value.trim();
  const userTC = tcRaw === "" ? null : Number(tcRaw);

  const actualRC = state.runningCount;
  const actualTC = trueCount();

  const rcOk = (userRC === actualRC);
  const tcOk = (userTC === null) ? true : (Math.abs(userTC - actualTC) <= 0.5);

  if(rcOk && tcOk){
    $("#countFeedback").innerHTML = `‚úÖ Correct. RC=${actualRC}, TC‚âà${actualTC.toFixed(1)}`;
  } else {
    $("#countFeedback").innerHTML = `‚ùå Off. Actual RC=${actualRC}, TC‚âà${actualTC.toFixed(1)}`;
  }
}

/* Hand flow */
async function dealHand(){
  if(state.shoe.length === 0 || penetrationReached()) buildNewShoe();

  const unit = clampInt($("#unit").value, 1);
  const chosenU = Number($("#betUnits").value);
  const bet = chosenU * unit;

  if(state.bank < bet){
    setMsg("Not enough bank for that bet.", "Lower bet units or reset bank in Settings.");
    return;
  }

  state.handBet = bet;
  state.bank -= bet;
  state.player = [];
  state.dealer = [];
  state.holeHidden = true;
  state.phase = "player";
  state.canDouble = true;
  $("#countFeedback").textContent = "";
  const spd = clampInt(state.speed, 0);

  setMsg("Dealing‚Ä¶", "");

  state.player.push(drawOne()); renderAll(); if(spd) await delay(spd);
  state.dealer.push(drawOne()); renderAll(); if(spd) await delay(spd);
  state.player.push(drawOne()); renderAll(); if(spd) await delay(spd);
  state.dealer.push(drawOne()); renderAll(); if(spd) await delay(spd);

  const pBJ = isBlackjack(state.player);
  const dBJ = isBlackjack(state.dealer);

  if(pBJ || dBJ){
    state.holeHidden = false;
    renderAll();
    if(pBJ && dBJ) return finishHand("Push (both BJ).", state.handBet);
    if(dBJ) return finishHand("Dealer Blackjack. You lose.", 0);
    // 3:2 payout -> return 2.5x bet
    return finishHand("Blackjack! You win 3:2.", Math.floor(state.handBet * 2.5));
  }

  const freq = $("#checkFreq").value;
  const prompt = (freq === "everyHand") || (freq === "random" && Math.random() < 0.34);
  setMsg("Your move: Hit / Stand / Double.", prompt ? "Tip: do a Count Check this hand." : "");
  renderAll();
}

async function hit(){
  if(state.phase !== "player") return;
  const spd = clampInt(state.speed, 0);
  state.player.push(drawOne());
  state.canDouble = false;
  renderAll(); if(spd) await delay(spd);

  const p = bjHandValue(state.player);
  if(p > 21){
    state.holeHidden = false;
    renderAll();
    return finishHand("BUST. You lose.", 0);
  }
  setMsg("Hit or Stand.", "");
  renderAll();
}

async function stand(){
  if(state.phase !== "player") return;
  state.phase = "dealer";
  state.canDouble = false;
  state.holeHidden = false;
  setMsg("Dealer plays‚Ä¶", "");
  renderAll();

  const spd = clampInt(state.speed, 0);
  while(bjHandValue(state.dealer) < 17){
    state.dealer.push(drawOne());
    renderAll(); if(spd) await delay(spd);
  }

  const p = bjHandValue(state.player);
  const d = bjHandValue(state.dealer);

  if(d > 21) return finishHand("Dealer busts. You win.", state.handBet * 2);
  if(p > d) return finishHand("You beat the dealer.", state.handBet * 2);
  if(p < d) return finishHand("Dealer wins.", 0);
  return finishHand("Push.", state.handBet);
}

async function doubleDown(){
  if(state.phase !== "player" || !state.canDouble) return;

  // double the bet
  if(state.bank < state.handBet){
    setMsg("Not enough bank to double.", "Lower bet units next hand.");
    return;
  }
  state.bank -= state.handBet;
  state.handBet *= 2;
  state.canDouble = false;

  const spd = clampInt(state.speed, 0);
  state.player.push(drawOne());
  renderAll(); if(spd) await delay(spd);

  const p = bjHandValue(state.player);
  if(p > 21){
    state.holeHidden = false;
    renderAll();
    return finishHand("Double‚Ä¶ BUST. You lose.", 0);
  }
  await stand();
}

function finishHand(message, payout){
  state.bank += payout;
  state.phase = "done";
  state.canDouble = false;

  const net = payout - state.handBet;
  const cls = net > 0 ? "good" : net < 0 ? "bad" : "warn";
  setMsg(message + ` (${net>0?"+":"-"}${money(Math.abs(net))})`, `RC=${state.runningCount} ‚Ä¢ TC‚âà${trueCount().toFixed(1)}`);
  // return to idle quickly
  setTimeout(()=>{
    state.phase = "idle";
    state.player = [];
    state.dealer = [];
    state.holeHidden = true;
    state.handBet = 0;
    setMsg("Press Deal for the next hand.", penetrationReached() ? "Cut reached ‚Äî next deal shuffles." : "");
    renderAll();
  }, 650);

  renderAll();
}

/* Wiring */
wireModal("#helpBackdrop", "#btnCloseHelp");
wireModal("#settingsBackdrop", "#btnCloseSettings");
wireModal("#countBackdrop", "#btnCloseCount");

$("#btnHow").addEventListener("click", ()=> openModal("#helpBackdrop"));
$("#btnSettings").addEventListener("click", ()=> openModal("#settingsBackdrop"));

document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape"){
    closeModal("#helpBackdrop");
    closeModal("#settingsBackdrop");
    closeModal("#countBackdrop");
  }
});

$("#btnStart").addEventListener("click", ()=>{
  state.started = true;
  setMsg("Press Deal to start a shoe.", "");
  renderAll();
});

$("#btnReset").addEventListener("click", resetAll);

$("#btnDeal").addEventListener("click", dealHand);
$("#btnHit").addEventListener("click", hit);
$("#btnStand").addEventListener("click", stand);
$("#btnDouble").addEventListener("click", doubleDown);

$("#btnCountCheck").addEventListener("click", ()=>{
  $("#countFeedback").textContent = "";
  $("#inpRC").value = "0";
  $("#inpTC").value = "";
  openModal("#countBackdrop");
});

$("#btnSubmitCount").addEventListener("click", gradeCountSubmission);

$("#unit").addEventListener("input", ()=> renderAll());
$("#betUnits").addEventListener("change", ()=> renderAll());
$("#checkFreq").addEventListener("change", ()=> renderAll());

/* Settings bindings */
$("#showRC").addEventListener("change", (e)=>{ state.showRC = e.target.checked; renderAll(); });
$("#showTC").addEventListener("change", (e)=>{ state.showTC = e.target.checked; renderAll(); });
$("#autoHints").addEventListener("change", (e)=>{ state.autoHints = e.target.checked; renderAll(); });

$("#decks").addEventListener("change", (e)=>{
  state.decks = clampInt(e.target.value, 1);
  buildNewShoe(true);
  setMsg("Shoe updated. RC reset.", "Press Deal to start.");
  renderAll();
});
$("#pen").addEventListener("change", (e)=>{ state.pen = clampFloat(e.target.value, 0.1); renderAll(); });
$("#speed").addEventListener("change", (e)=>{ state.speed = clampInt(e.target.value, 0); renderAll(); });

$("#btnShuffle").addEventListener("click", ()=>{
  buildNewShoe();
  renderAll();
});
$("#btnWipe").addEventListener("click", resetAll);

/* Save on background/close */
window.addEventListener("beforeunload", autoSave);
document.addEventListener("visibilitychange", ()=>{ if(document.visibilityState === "hidden") autoSave(); });

/* Service worker (offline) */
if ("serviceWorker" in navigator) navigator.serviceWorker.register("./sw.js");

/* Init */
load();
if(!Array.isArray(state.shoe) || state.shoe.length === 0) buildNewShoe(true);

// If you reopen mid-hand, reset to idle (prevents weird stuck state)
if(state.phase && state.phase !== "idle"){
  state.phase = "idle";
  state.player = [];
  state.dealer = [];
  state.holeHidden = true;
  state.canDouble = false;
  state.handBet = 0;
}

renderAll();
</script>
</body>
</html>
