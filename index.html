<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blackjack Card Counting Trainer (Hi-Lo)</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">
  <style>
    :root{
      --bg:#0b1220; --panel:#111b2e; --text:#e7eefc; --muted:#a9b6d3;
      --accent:#4cc9f0; --good:#49d17c; --bad:#ff5d5d; --warn:#ffd166;
      --border:rgba(255,255,255,.10);
      --shadow: 0 12px 34px rgba(0,0,0,.38);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:radial-gradient(1200px 700px at 20% 0%, #1a2b57 0%, var(--bg) 55%, #070b14 100%);
    }
    header{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:rgba(10,16,32,.62);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background:linear-gradient(135deg, rgba(76,201,240,.95), rgba(73,209,124,.9));
      box-shadow: var(--shadow);
    }
    .title{line-height:1.15}
    .title b{display:block; font-size:15px; letter-spacing:.2px}
    .title span{display:block; font-size:12px; color:var(--muted)}
    .topPills{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
    .pill{
      padding:8px 10px; border:1px solid var(--border); border-radius:999px;
      background:rgba(255,255,255,.04); font-size:13px;
    }
    .pill b{color:var(--accent)}
    .btn{
      cursor:pointer; user-select:none;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:9px 12px; border-radius:14px;
      font-weight:800; font-size:13px;
      transition:.14s transform,.14s background,.14s border;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.07)}
    .btn:active{transform:translateY(0px)}
    .btn.primary{background: rgba(76,201,240,.16); border-color: rgba(76,201,240,.35)}
    .btn.good{background: rgba(73,209,124,.14); border-color: rgba(73,209,124,.35)}
    .btn.bad{background: rgba(255,93,93,.13); border-color: rgba(255,93,93,.35)}
    .btn.warn{background: rgba(255,209,102,.14); border-color: rgba(255,209,102,.35)}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none}

    main{
      max-width:1180px; margin:0 auto; padding:16px;
      display:grid; grid-template-columns: 330px 1fr; gap:14px;
    }
    @media (max-width: 1020px){ main{grid-template-columns:1fr} }

    .panel{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .side{padding:14px}
    .content{padding:14px}
    h3{margin:0 0 10px 0; font-size:14px; color:var(--muted); letter-spacing:.25px}
    .box{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background:rgba(0,0,0,.16);
      padding:12px;
    }
    .stack{display:grid; gap:10px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .small{font-size:12px; color:var(--muted)}
    .badge{
      padding:6px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      font-weight:700;
    }
    label{font-size:12px; color:var(--muted)}
    select, input[type="number"], input[type="text"]{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
    }
    select:focus, input:focus{border-color: rgba(76,201,240,.5)}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    @media (max-width: 720px){
      .grid2,.grid3{grid-template-columns:1fr}
    }

    .tableGrid{
      display:grid; grid-template-columns: 1.1fr .9fr; gap:12px;
    }
    @media (max-width: 980px){ .tableGrid{grid-template-columns:1fr} }

    .cards{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .card{
      width:72px; height:98px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      display:grid; place-items:center;
      position:relative;
      box-shadow: 0 10px 20px rgba(0,0,0,.22);
      font-weight:900;
    }
    .card.red{border-color: rgba(255,93,93,.25)}
    .card .corner{position:absolute; top:8px; left:8px; font-size:12px; opacity:.95}
    .card .corner2{position:absolute; bottom:8px; right:8px; font-size:12px; opacity:.95; transform:rotate(180deg)}
    .card .rank{font-size:16px}
    .card .suit{font-size:20px}
    .card.red .suit{color: var(--bad)}
    .card.black .suit{color:#dbe7ff}
    .hole{
      background:linear-gradient(180deg, rgba(76,201,240,.12), rgba(0,0,0,.16)) !important;
    }

    .bigMsg{
      font-size:22px; font-weight:1000; letter-spacing:.2px; margin-top:8px;
    }
    .status.good{color:var(--good)}
    .status.bad{color:var(--bad)}
    .status.warn{color:var(--warn)}

    .log{
      max-height:240px; overflow:auto; padding-right:4px;
    }
    .entry{
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      margin-bottom:8px;
      font-size:13px;
    }
    .entry .meta{font-size:11px; color:var(--muted); margin-top:4px}

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      padding:2px 6px; border-radius:9px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.24);
      color:var(--muted);
      font-size:12px;
    }

    .meter{
      height:10px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
    }
    .meter > div{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(255,93,93,.8), rgba(255,209,102,.9), rgba(73,209,124,.9));
    }

    .hintGrid{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px;
      margin-top:10px;
    }
    @media (max-width: 720px){ .hintGrid{grid-template-columns:1fr} }

    .toggleRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px;
    }
    .toggle{
      display:flex; gap:8px; align-items:center;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background:rgba(0,0,0,.14);
      cursor:pointer; user-select:none;
    }
    .toggle input{accent-color: var(--accent)}

    /* ======= Modal ======= */
    .modalBackdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
      z-index:200;
      padding:16px;
    }
    .modalBackdrop.show{display:flex; align-items:center; justify-content:center;}
    .modal{
      width:min(940px, 100%);
      max-height: 86vh;
      overflow:auto;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(17,27,46,.98), rgba(9,13,24,.98));
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      padding:14px;
    }
    .modalHeader{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      padding-bottom:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      margin-bottom:10px;
    }
    .modalHeader h2{margin:0; font-size:18px}
    .modalHeader p{margin:4px 0 0 0; color:var(--muted); font-size:13px}
    .modalBody{display:grid; gap:12px}
    .step{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background:rgba(0,0,0,.14);
      padding:12px;
    }
    .step h4{margin:0 0 6px 0; font-size:14px}
    .step ul{margin:8px 0 0 18px; color:var(--text)}
    .step li{margin:6px 0; color:var(--muted)}
    .callout{
      border-left:4px solid rgba(76,201,240,.7);
      padding:10px 12px;
      border-radius:12px;
      background:rgba(76,201,240,.08);
      color:var(--muted);
      font-size:13px;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      background:rgba(0,0,0,.25);
      padding:2px 6px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:10px;
      color:var(--text);
      font-size:12px;
    }
  </style>
</head>
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
  }
</script>
<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div class="title">
      <b>Card Counting Trainer</b>
      <span>Hi-Lo ‚Ä¢ shoe + penetration ‚Ä¢ discard tray ‚Ä¢ graded practice</span>
    </div>
  </div>
  <div class="topPills">
    <button class="btn primary" id="btnHow">How to Count</button>
    <div class="pill">Trainer Bank: <b id="bank">$1000</b></div>
    <div class="pill">Running: <b id="rcTop">0</b></div>
    <div class="pill">True: <b id="tcTop">0.0</b></div>
    <button class="btn" id="btnSave">Save</button>
    <button class="btn" id="btnReset">Reset</button>
  </div>
</header>

<main>
  <section class="panel side">
    <h3>Trainer Settings</h3>
    <div class="stack">
      <div class="box">
        <div class="grid2">
          <div>
            <label>Mode</label>
            <select id="mode">
              <option value="beginner">Beginner (count shown)</option>
              <option value="intermediate">Intermediate (running hidden, true optional)</option>
              <option value="advanced">Advanced (no count UI, graded)</option>
            </select>
          </div>
          <div>
            <label>Decks in shoe</label>
            <select id="decks">
              <option>1</option>
              <option>2</option>
              <option>4</option>
              <option selected>6</option>
              <option>8</option>
            </select>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Penetration (reshuffle point)</label>
            <select id="pen">
              <option value="0.5">50%</option>
              <option value="0.6">60%</option>
              <option value="0.65">65%</option>
              <option value="0.7">70%</option>
              <option value="0.75" selected>75%</option>
              <option value="0.8">80%</option>
              <option value="0.85">85%</option>
            </select>
          </div>
          <div>
            <label>Deal speed (ms)</label>
            <select id="speed">
              <option value="0">Instant</option>
              <option value="220">Fast</option>
              <option value="420" selected>Normal</option>
              <option value="700">Slow</option>
            </select>
          </div>
        </div>

        <div class="toggleRow">
          <label class="toggle"><input type="checkbox" id="showRC" checked /> Show running count</label>
          <label class="toggle"><input type="checkbox" id="showTC" checked /> Show true count</label>
          <label class="toggle"><input type="checkbox" id="autoHints" checked /> Show bet suggestion</label>
        </div>

        <div class="small" style="margin-top:10px">
          Hi-Lo values: 2‚Äì6 = +1 ‚Ä¢ 7‚Äì9 = 0 ‚Ä¢ 10‚ÄìA = ‚àí1
        </div>
      </div>

      <div class="box">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:900">Shoe / Discard</div>
            <div class="small">Reshuffles when penetration reached</div>
          </div>
          <span class="badge" id="shoeInfo">‚Äî</span>
        </div>
        <div class="meter" style="margin-top:10px"><div id="penBar"></div></div>
        <div class="hintGrid">
          <div class="badge">Cards Dealt: <b id="dealt">0</b></div>
          <div class="badge">Decks Left: <b id="decksLeft">6.0</b></div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn warn" id="btnShuffle">Shuffle Now</button>
          <button class="btn" id="btnClearStats">Clear Stats</button>
        </div>
      </div>

      <div class="box">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:900">Performance</div>
            <div class="small">Tracks accuracy + bet decisions</div>
          </div>
          <span class="badge" id="perfBadge">‚Äî</span>
        </div>
        <div class="hintGrid">
          <div class="badge">Count Checks: <b id="checks">0</b></div>
          <div class="badge">Count Errors: <b id="errors">0</b></div>
          <div class="badge">Bet Checks: <b id="betChecks">0</b></div>
          <div class="badge">Bet Errors: <b id="betErrors">0</b></div>
        </div>
      </div>

      <div class="box">
        <div style="font-weight:900">Hotkeys</div>
        <div class="small" style="margin-top:6px">
          <span class="kbd">D</span> Deal ‚Ä¢
          <span class="kbd">H</span> Hit ‚Ä¢
          <span class="kbd">S</span> Stand ‚Ä¢
          <span class="kbd">F</span> Fold ‚Ä¢
          <span class="kbd">C</span> Count Check ‚Ä¢
          <span class="kbd">B</span> Bet Check ‚Ä¢
          <span class="kbd">Esc</span> Close Help
        </div>
      </div>
    </div>
  </section>

  <section class="panel content">
    <div class="tableGrid">
      <div class="stack">
        <div class="box">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:1000">Blackjack Table</div>
              <div class="small">Dealer stands on 17 ‚Ä¢ no splits ‚Ä¢ double on first decision</div>
            </div>
            <div class="row">
              <span class="badge">Bet Unit: <b id="unitLabel">$50</b></span>
              <span class="badge">Hand Bet: <b id="handBetLabel">$0</b></span>
            </div>
          </div>

          <div class="grid3" style="margin-top:10px">
            <div>
              <label>Base Unit ($)</label>
              <input id="unit" type="number" min="1" step="1" value="50" />
              <div class="small" style="margin-top:6px">Used for bet ramp & sizing.</div>
            </div>
            <div>
              <label>Your bet (units)</label>
              <select id="betUnits">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                <option value="4">4</option><option value="6">6</option><option value="8">8</option>
                <option value="10">10</option><option value="12">12</option>
              </select>
              <div class="small" style="margin-top:6px">Trainer grades this vs true count.</div>
            </div>
            <div>
              <label>Count check frequency</label>
              <select id="checkFreq">
                <option value="everyHand" selected>Every hand</option>
                <option value="random">Random (about 1/3 hands)</option>
                <option value="manual">Manual only</option>
              </select>
              <div class="small" style="margin-top:6px">Prompts you to enter your count.</div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button class="btn primary" id="btnDeal">Deal</button>
            <button class="btn" id="btnHit" disabled>Hit</button>
            <button class="btn" id="btnStand" disabled>Stand</button>
            <button class="btn warn" id="btnDouble" disabled>Double</button>
            <button class="btn bad" id="btnFold" disabled>Fold</button>
            <button class="btn good" id="btnCountCheck">Count Check</button>
            <button class="btn good" id="btnBetCheck">Bet Check</button>
          </div>

          <div class="row" style="justify-content:space-between; margin-top:10px">
            <div class="badge">Suggested Bet: <b id="suggestBet">‚Äî</b></div>
            <div class="badge">To Call: <b id="toCall">‚Äî</b></div>
          </div>

          <div class="bigMsg" id="msg">Press Deal to start a shoe.</div>
        </div>

        <div class="box">
          <div class="row" style="justify-content:space-between">
            <div style="font-weight:1000">Dealer</div>
            <div class="badge">Total: <b id="dTotal">‚Äî</b></div>
          </div>
          <div class="cards" id="dealerCards" style="margin-top:10px"></div>
        </div>

        <div class="box">
          <div class="row" style="justify-content:space-between">
            <div style="font-weight:1000">You</div>
            <div class="badge">Total: <b id="pTotal">‚Äî</b></div>
          </div>
          <div class="cards" id="playerCards" style="margin-top:10px"></div>
        </div>

        <div class="box">
          <div style="font-weight:1000">Count Check</div>
          <div class="small">Enter the running count you believe it is right now (and optionally true count).</div>
          <div class="grid2" style="margin-top:10px">
            <div>
              <label>Your Running Count</label>
              <input id="inpRC" type="number" step="1" value="0" />
            </div>
            <div>
              <label>Your True Count (optional)</label>
              <input id="inpTC" type="number" step="0.1" value="0" />
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn good" id="btnSubmitCount">Submit Count</button>
            <span class="small" id="countFeedback"></span>
          </div>
        </div>
      </div>

      <div class="stack">
        <div class="box">
          <div class="row" style="justify-content:space-between">
            <div style="font-weight:1000">Trainer Log</div>
            <span class="badge" id="lastResult">‚Äî</span>
          </div>
          <div class="log" id="log" style="margin-top:10px"></div>
          <div class="small" style="margin-top:10px">
            Training / entertainment only (no real money).
          </div>
        </div>

        <div class="box">
          <div style="font-weight:1000">How this grades you</div>
          <div class="small" style="margin-top:8px">
            ‚Ä¢ <b>Count Checks</b>: compares your entered RC/TC to the shoe‚Äôs actual values.<br/>
            ‚Ä¢ <b>Bet Checks</b>: compares your chosen bet to a simple ‚Äúbet ramp‚Äù suggestion based on true count.
          </div>
          <div class="small" style="margin-top:10px">
            Default ramp:<br/>
            TC ‚â§ 0 ‚Üí 1u ‚Ä¢ TC 1 ‚Üí 2u ‚Ä¢ TC 2 ‚Üí 4u ‚Ä¢ TC 3 ‚Üí 8u ‚Ä¢ TC ‚â• 4 ‚Üí 12u
          </div>
        </div>

        <div class="box">
          <div style="font-weight:1000">UI hints</div>
          <div class="small" style="margin-top:8px">
            Beginner shows counts. Intermediate hides RC by default. Advanced hides both (you should self-check).
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- ===== Help / How-To Modal ===== -->
<div class="modalBackdrop" id="helpBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="How to count cards">
    <div class="modalHeader">
      <div>
        <h2>How to Count Cards (Hi-Lo) ‚Äî The Full Process</h2>
        <p>Read this once, then practice with the trainer. Close with <span class="mono">Esc</span>.</p>
      </div>
      <div class="row">
        <button class="btn" id="btnCloseHelp">Close</button>
      </div>
    </div>

    <div class="modalBody">
      <div class="callout">
        <b>Goal:</b> Keep a <b>Running Count</b> of what‚Äôs been dealt. Convert to a <b>True Count</b> using <b>decks remaining</b>. Bet more when the true count is high.
      </div>

      <div class="step">
        <h4>1) Memorize the Hi-Lo Values (this is everything)</h4>
        <div class="small">You update your count for every card that is revealed (player, dealer upcard, dealer hole when shown, and dealer hits).</div>
        <ul>
          <li><b>2‚Äì6</b> ‚Üí <span class="mono">+1</span> (low cards help the dealer bust less; seeing them go out is good for you)</li>
          <li><b>7‚Äì9</b> ‚Üí <span class="mono">0</span></li>
          <li><b>10, J, Q, K, A</b> ‚Üí <span class="mono">‚àí1</span> (high cards help you: blackjacks, doubles, dealer busts)</li>
        </ul>
      </div>

      <div class="step">
        <h4>2) Keep the Running Count (RC)</h4>
        <div class="small">Start at <span class="mono">0</span> after a shuffle. Add the Hi-Lo value as cards appear.</div>
        <ul>
          <li>Example: cards shown = 5 (+1), K (‚àí1), 3 (+1), 9 (0) ‚Üí RC = <span class="mono">+1</span></li>
          <li><b>Only count exposed cards</b>. If you can‚Äôt see it yet, you can‚Äôt count it (until revealed).</li>
        </ul>
      </div>

      <div class="step">
        <h4>3) Estimate Decks Remaining</h4>
        <div class="small">Casinos use a shoe (often 6‚Äì8 decks). You estimate how much is left.</div>
        <ul>
          <li>Rule of thumb: 52 cards ‚âà 1 deck. Half a deck ‚âà 26 cards.</li>
          <li>This trainer shows <b>Decks Left</b> so you can learn what those estimates feel like.</li>
        </ul>
      </div>

      <div class="step">
        <h4>4) Convert to True Count (TC)</h4>
        <div class="small">True count normalizes the running count by how many decks remain.</div>
        <div class="callout">
          <b>True Count</b> = <span class="mono">Running Count √∑ Decks Remaining</span>
        </div>
        <ul>
          <li>Example: RC = +8 with ~4 decks left ‚Üí TC ‚âà +2</li>
          <li>Example: RC = +8 with ~2 decks left ‚Üí TC ‚âà +4 (much stronger!)</li>
        </ul>
      </div>

      <div class="step">
        <h4>5) Bet More When TC Is High (Bet Ramp)</h4>
        <div class="small">Counting is only valuable if you scale your bets. This trainer grades you using a simple ramp.</div>
        <ul>
          <li>TC ‚â§ 0 ‚Üí 1 unit</li>
          <li>TC ~ 1 ‚Üí 2 units</li>
          <li>TC ~ 2 ‚Üí 4 units</li>
          <li>TC ~ 3 ‚Üí 8 units</li>
          <li>TC ‚â• 4 ‚Üí 12 units</li>
        </ul>
        <div class="small">In real play, the exact ramp depends on rules, bankroll, risk tolerance, and heat. Here, it‚Äôs for training muscle memory.</div>
      </div>

      <div class="step">
        <h4>6) When to Update Your Count</h4>
        <ul>
          <li>Immediately after the initial deal: your 2 cards + dealer upcard.</li>
          <li>When you hit: count each hit card.</li>
          <li>When dealer reveals hole card: count it then.</li>
          <li>When dealer draws: count each dealer draw.</li>
        </ul>
      </div>

      <div class="step">
        <h4>7) Practice Routine (fast improvement)</h4>
        <ul>
          <li>Start in <b>Beginner</b> with RC/TC shown for 10 minutes.</li>
          <li>Switch to <b>Intermediate</b>: hide RC, keep TC visible (optional) for 10 minutes.</li>
          <li>Finish in <b>Advanced</b>: hide both, do count checks every hand for 10 minutes.</li>
          <li>Use <b>Count Check</b> to verify your RC/TC. Use <b>Bet Check</b> to verify your ramp decision.</li>
        </ul>
      </div>

      <div class="step">
        <h4>8) Common Mistakes</h4>
        <ul>
          <li>Forgetting to count the dealer hole card when it flips.</li>
          <li>Counting cards you didn‚Äôt actually see yet.</li>
          <li>Not converting to true count (RC alone is misleading in multi-deck shoes).</li>
          <li>Changing your count after a push/lose/win ‚Äî outcomes don‚Äôt matter, only cards dealt.</li>
        </ul>
      </div>

      <div class="callout">
        In this trainer: turn off ‚ÄúShow running/true count‚Äù to simulate real play, and use Count Check to test yourself.
      </div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   Card Counting Trainer ‚Äî Single-file, no deps
   - Hi-Lo running count
   - True count (RC / decks remaining)
   - 1‚Äì8 deck shoe w/ penetration + reshuffle
   - Discard progress meter
   - Blackjack engine (no split; double on first decision)
   - Training: count checks + bet checks + stats
========================================================= */

const $ = (sel, el=document) => el.querySelector(sel);
const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];

const SUITS = [
  {sym:"‚ô†", color:"black"},
  {sym:"‚ô•", color:"red"},
  {sym:"‚ô¶", color:"red"},
  {sym:"‚ô£", color:"black"},
];
const RANKS = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];

const STORAGE_KEY = "count_trainer_v2";

function money(n){
  const sign = n < 0 ? "-" : "";
  const abs = Math.abs(Math.round(n));
  return sign + "$" + abs.toString();
}
function clampInt(v, min=0){
  v = Math.floor(Number(v||0));
  if(!isFinite(v)) v = 0;
  return Math.max(min, v);
}
function clampFloat(v, min=0){
  v = Number(v||0);
  if(!isFinite(v)) v = 0;
  return Math.max(min, v);
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}
function nowStamp(){
  const d = new Date();
  return d.toLocaleString();
}
function delay(ms){ return new Promise(res=>setTimeout(res, ms)); }

/* -------------------------------
   Hi-Lo Value
--------------------------------*/
function hiLoValue(rank){
  // 2‚Äì6 +1, 7‚Äì9 0, 10‚ÄìA -1
  if(rank === "A" || rank === "K" || rank === "Q" || rank === "J" || rank === "10") return -1;
  const n = Number(rank);
  if(n >= 2 && n <= 6) return +1;
  if(n >= 7 && n <= 9) return 0;
  return 0;
}

/* -------------------------------
   Blackjack hand value
--------------------------------*/
function bjCardValue(rank){
  if(rank === "A") return 11;
  if(["K","Q","J","10"].includes(rank)) return 10;
  return Number(rank);
}
function bjHandValue(cards){
  let total = 0;
  let aces = 0;
  for(const c of cards){
    total += bjCardValue(c.rank);
    if(c.rank === "A") aces++;
  }
  while(total > 21 && aces > 0){
    total -= 10;
    aces--;
  }
  return total;
}
function isBlackjack(cards){
  return cards.length === 2 && bjHandValue(cards) === 21;
}

/* -------------------------------
   State
--------------------------------*/
let state = {
  bank: 1000,
  mode: "beginner",
  decks: 6,
  pen: 0.75,
  speed: 420,
  showRC: true,
  showTC: true,
  autoHints: true,

  // Shoe
  shoe: [],
  dealt: 0,
  runningCount: 0,

  // Hand
  phase: "idle", // idle | player | dealer | done
  player: [],
  dealer: [],
  holeHidden: true,
  canDouble: false,
  handBet: 0,

  // Trainer stats
  checks: 0,
  errors: 0,
  betChecks: 0,
  betErrors: 0,

  // Log
  log: []
};

function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  toast("Saved.");
}
function load(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){
    try { state = JSON.parse(raw); }
    catch(e){}
  }
}
function resetAll(){
  localStorage.removeItem(STORAGE_KEY);
  state = {
    bank: 1000,
    mode: "beginner",
    decks: 6,
    pen: 0.75,
    speed: 420,
    showRC: true,
    showTC: true,
    autoHints: true,
    shoe: [],
    dealt: 0,
    runningCount: 0,
    phase: "idle",
    player: [],
    dealer: [],
    holeHidden: true,
    canDouble: false,
    handBet: 0,
    checks: 0,
    errors: 0,
    betChecks: 0,
    betErrors: 0,
    log: []
  };
  buildNewShoe(true);
  renderAll();
  toast("Reset.");
}

/* -------------------------------
   Shoe logic
--------------------------------*/
function buildNewShoe(silent=false){
  state.shoe = [];
  for(let d=0; d<state.decks; d++){
    for(const s of SUITS){
      for(const r of RANKS){
        state.shoe.push({rank:r, suit:s.sym, color:s.color});
      }
    }
  }
  shuffle(state.shoe);
  state.dealt = 0;
  state.runningCount = 0;
  if(!silent) logEntry(`üåÄ New shoe shuffled (${state.decks} decks). RC reset to 0.`, 0);
}
function shoeSize(){ return state.decks * 52; }
function cardsRemaining(){ return Math.max(0, shoeSize() - state.dealt); }
function decksRemaining(){ return cardsRemaining() / 52; }
function penetrationReached(){ return state.dealt >= Math.floor(state.pen * shoeSize()); }
function trueCount(){
  const dr = decksRemaining();
  if(dr <= 0.25) return state.runningCount;
  return state.runningCount / dr;
}

/* -------------------------------
   UI / Logging
--------------------------------*/
function toast(msg){
  $("#lastResult").textContent = msg;
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> $("#lastResult").textContent = "‚Äî", 2000);
}
function logEntry(html, delta){
  const entry = { html, delta, at: nowStamp() };
  state.log.unshift(entry);
  if(state.log.length > 120) state.log.pop();
  renderLog();
}
function renderLog(){
  const el = $("#log");
  el.innerHTML = "";
  if(state.log.length === 0){
    el.innerHTML = `<div class="small">No actions yet.</div>`;
    return;
  }
  for(const e of state.log){
    const cls = e.delta > 0 ? "good" : (e.delta < 0 ? "bad" : "warn");
    const sign = e.delta > 0 ? "+" : "";
    const deltaTxt = e.delta === 0 ? "" : ` <span class="status ${cls}">(${sign}${money(e.delta)})</span>`;
    const div = document.createElement("div");
    div.className = "entry";
    div.innerHTML = `${e.html}${deltaTxt}<div class="meta">${e.at}</div>`;
    el.appendChild(div);
  }
}

/* -------------------------------
   Card draw with counting
--------------------------------*/
function drawOne(){
  if(state.shoe.length === 0 || cardsRemaining() === 0){
    buildNewShoe();
  }
  const c = state.shoe.pop();
  state.dealt++;
  state.runningCount += hiLoValue(c.rank);
  return c;
}

/* -------------------------------
   Bet ramp suggestion
--------------------------------*/
function suggestedUnits(tc){
  if(tc <= 0.5) return 1;
  if(tc <= 1.5) return 2;
  if(tc <= 2.5) return 4;
  if(tc <= 3.5) return 8;
  return 12;
}

/* -------------------------------
   Render cards
--------------------------------*/
function cardEl(c, hidden=false){
  const div = document.createElement("div");
  div.className = `card ${c.color}`;
  if(hidden){
    div.classList.add("hole");
    div.innerHTML = `<div class="corner">üÇ†</div><div class="suit">‚óÜ</div><div class="corner2">üÇ†</div>`;
  } else {
    div.innerHTML = `
      <div class="corner">${c.rank}${c.suit}</div>
      <div style="text-align:center">
        <div class="rank">${c.rank}</div>
        <div class="suit">${c.suit}</div>
      </div>
      <div class="corner2">${c.rank}${c.suit}</div>
    `;
  }
  return div;
}
function renderHands(){
  const d = $("#dealerCards");
  const p = $("#playerCards");
  d.innerHTML = "";
  p.innerHTML = "";

  state.dealer.forEach((c,i)=>{
    const hide = state.holeHidden && i===1 && (state.phase==="player" || state.phase==="dealer");
    d.appendChild(cardEl(c, hide));
  });
  state.player.forEach(c=> p.appendChild(cardEl(c,false)));

  $("#dTotal").textContent = (state.holeHidden && (state.phase==="player"||state.phase==="dealer"))
    ? "?"
    : (state.dealer.length ? bjHandValue(state.dealer) : "‚Äî");
  $("#pTotal").textContent = state.player.length ? bjHandValue(state.player) : "‚Äî";
}

/* -------------------------------
   Main rendering
--------------------------------*/
function applyModeVisibility(){
  const mode = state.mode;
  const showRC = state.showRC && (mode !== "advanced");
  const showTC = state.showTC && (mode !== "advanced");

  $("#rcTop").textContent = showRC ? String(state.runningCount) : "‚Äî";
  $("#tcTop").textContent = showTC ? (trueCount().toFixed(1)) : "‚Äî";
}

function renderShoe(){
  const total = shoeSize();
  const dealt = state.dealt;
  const remain = cardsRemaining();
  const penPct = Math.min(1, dealt / total);
  $("#dealt").textContent = String(dealt);
  $("#decksLeft").textContent = decksRemaining().toFixed(1);

  $("#penBar").style.width = (penPct * 100).toFixed(1) + "%";
  $("#shoeInfo").textContent = penetrationReached()
    ? "Penetration reached (shuffle soon)"
    : `Pen ${(state.pen*100).toFixed(0)}% ‚Ä¢ ${remain} cards left`;

  const perf = (state.checks===0) ? "‚Äî" : `${Math.max(0, Math.round(100*(1 - state.errors/Math.max(1,state.checks))))}% count`;
  const perf2 = (state.betChecks===0) ? "‚Äî" : `${Math.max(0, Math.round(100*(1 - state.betErrors/Math.max(1,state.betChecks))))}% bets`;
  $("#perfBadge").textContent = `${perf} ‚Ä¢ ${perf2}`;

  $("#checks").textContent = String(state.checks);
  $("#errors").textContent = String(state.errors);
  $("#betChecks").textContent = String(state.betChecks);
  $("#betErrors").textContent = String(state.betErrors);

  $("#bank").textContent = money(state.bank);

  applyModeVisibility();
}

function renderSuggestedBet(){
  const unit = clampInt($("#unit").value, 1);
  const tc = trueCount();
  const su = suggestedUnits(tc);
  const sug = `${su}u = ${money(su * unit)}`;
  $("#suggestBet").textContent = state.autoHints ? sug : "‚Äî";
  $("#unitLabel").textContent = money(unit);

  const chosenUnits = Number($("#betUnits").value);
  $("#handBetLabel").textContent = money(chosenUnits * unit);
  $("#toCall").textContent = money(chosenUnits * unit);
}

function setButtons(){
  const inPlay = (state.phase === "player");
  const dealerPlay = (state.phase === "dealer");
  $("#btnHit").disabled = !inPlay;
  $("#btnStand").disabled = !inPlay;
  $("#btnFold").disabled = !inPlay;
  $("#btnDouble").disabled = !(inPlay && state.canDouble);
  $("#btnDeal").disabled = (inPlay || dealerPlay);
}

function renderAll(){
  $("#mode").value = state.mode;
  $("#decks").value = String(state.decks);
  $("#pen").value = String(state.pen);
  $("#speed").value = String(state.speed);
  $("#showRC").checked = state.showRC;
  $("#showTC").checked = state.showTC;
  $("#autoHints").checked = state.autoHints;

  renderShoe();
  renderHands();
  renderSuggestedBet();
  setButtons();
  renderLog();
}

/* -------------------------------
   Training prompts + grading
--------------------------------*/
function shouldPromptCountCheck(){
  const freq = $("#checkFreq").value;
  if(freq === "manual") return false;
  if(freq === "everyHand") return true;
  return Math.random() < 0.34;
}

function gradeCountSubmission(){
  const userRC = Math.trunc(Number($("#inpRC").value));
  const userTC = Number($("#inpTC").value);

  const actualRC = state.runningCount;
  const actualTC = trueCount();

  state.checks++;

  const rcOk = (userRC === actualRC);
  const tcProvided = Number.isFinite(userTC) && $("#inpTC").value !== "";
  const tcOk = !tcProvided ? true : (Math.abs(userTC - actualTC) <= 0.5);

  let msg = "";
  if(rcOk && tcOk){
    msg = `‚úÖ Correct. RC=${actualRC}, TC‚âà${actualTC.toFixed(1)}`;
  } else {
    state.errors++;
    msg = `‚ùå Off. Actual RC=${actualRC}, TC‚âà${actualTC.toFixed(1)}`;
  }
  $("#countFeedback").innerHTML = msg;
  toast(rcOk && tcOk ? "Count correct" : "Count incorrect");
  renderShoe();
}

function gradeBetChoice(){
  const unit = clampInt($("#unit").value, 1);
  const chosenU = Number($("#betUnits").value);
  const tc = trueCount();
  const sugU = suggestedUnits(tc);

  state.betChecks++;
  const ok = (chosenU === sugU);
  if(!ok) state.betErrors++;

  const chosen = money(chosenU * unit);
  const sug = money(sugU * unit);

  const msg = ok
    ? `‚úÖ Bet check: good (${chosenU}u). Suggested was ${sugU}u.`
    : `‚ùå Bet check: you chose ${chosenU}u (${chosen}) ‚Äî suggested ${sugU}u (${sug}).`;

  logEntry(`üéØ ${msg}`, 0);
  toast(ok ? "Bet OK" : "Bet off");
  renderShoe();
}

/* -------------------------------
   Hand Flow
--------------------------------*/
async function dealHand(){
  if(state.shoe.length === 0 || penetrationReached()){
    buildNewShoe();
  }

  const unit = clampInt($("#unit").value, 1);
  const chosenUnits = Number($("#betUnits").value);
  const bet = chosenUnits * unit;

  if(state.bank < bet){
    toast("Trainer bank too low ‚Äî add funds or lower bet.");
    return;
  }

  state.handBet = bet;
  state.bank -= bet;
  state.player = [];
  state.dealer = [];
  state.holeHidden = true;
  state.phase = "player";
  state.canDouble = true;
  $("#countFeedback").textContent = "";

  const spd = clampInt($("#speed").value, 0);

  state.player.push(drawOne()); renderAll(); if(spd) await delay(spd);
  state.dealer.push(drawOne()); renderAll(); if(spd) await delay(spd);
  state.player.push(drawOne()); renderAll(); if(spd) await delay(spd);
  state.dealer.push(drawOne()); renderAll(); if(spd) await delay(spd);

  const pBJ = isBlackjack(state.player);
  const dBJ = isBlackjack(state.dealer);

  if(pBJ || dBJ){
    state.holeHidden = false;
    renderAll();
    if(pBJ && dBJ){
      finishHand("push", "Both Blackjack ‚Äî push.", state.handBet);
      return;
    }
    if(dBJ){
      finishHand("lose", "Dealer Blackjack ‚Äî you lose.", 0);
      return;
    }
    const payout = Math.floor(state.handBet * 2.5);
    finishHand("win", "Blackjack! You win 3:2.", payout);
    return;
  }

  $("#msg").textContent = "Your move: Hit / Stand / Double / Fold.";
  if(shouldPromptCountCheck()){
    $("#msg").textContent += " (Count check suggested ‚Äî press Count Check.)";
  }

  renderAll();
}

async function hit(){
  if(state.phase !== "player") return;
  const spd = clampInt($("#speed").value, 0);
  state.player.push(drawOne());
  state.canDouble = false;
  renderAll();
  if(spd) await delay(spd);

  const p = bjHandValue(state.player);
  if(p > 21){
    state.holeHidden = false;
    renderAll();
    finishHand("lose", "BUST ‚Äî you lose.", 0);
    return;
  }
  $("#msg").textContent = "Hit or Stand.";
  renderAll();
}

async function stand(){
  if(state.phase !== "player") return;
  state.phase = "dealer";
  state.canDouble = false;
  $("#msg").textContent = "Dealer plays‚Ä¶";
  state.holeHidden = false;
  renderAll();

  const spd = clampInt($("#speed").value, 0);

  while(bjHandValue(state.dealer) < 17){
    state.dealer.push(drawOne());
    renderAll();
    if(spd) await delay(spd);
  }

  const p = bjHandValue(state.player);
  const d = bjHandValue(state.dealer);

  if(d > 21) return finishHand("win", "Dealer busts ‚Äî you win.", state.handBet * 2);
  if(p > d) return finishHand("win", "You beat the dealer.", state.handBet * 2);
  if(p < d) return finishHand("lose", "Dealer wins.", 0);
  return finishHand("push", "Push.", state.handBet);
}

async function doubleDown(){
  if(state.phase !== "player" || !state.canDouble) return;
  const extra = state.handBet;
  if(state.bank < extra){
    toast("Not enough trainer bank to double.");
    return;
  }
  state.bank -= extra;
  state.handBet += extra;
  state.canDouble = false;

  const spd = clampInt($("#speed").value, 0);
  state.player.push(drawOne());
  renderAll();
  if(spd) await delay(spd);

  const p = bjHandValue(state.player);
  if(p > 21){
    state.holeHidden = false;
    renderAll();
    finishHand("lose", "Double down‚Ä¶ BUST.", 0);
    return;
  }
  await stand();
}

function fold(){
  if(state.phase !== "player") return;
  state.holeHidden = false;
  renderAll();
  const returned = Math.floor(state.handBet * 0.5);
  finishHand("lose", "You folded (trainer) ‚Äî half bet returned.", returned);
}

function finishHand(outcome, message, payout){
  state.bank += payout;
  state.phase = "done";
  state.canDouble = false;

  const net = payout - state.handBet;
  const cls = net > 0 ? "good" : net < 0 ? "bad" : "warn";

  $("#msg").innerHTML = `${message} <span class="status ${cls}">${net>0?("+"+money(net)): net<0?("-"+money(-net)):"$0"}</span>`;
  logEntry(`üÇ° Hand ended: ${message} Bet ${money(state.handBet)}.`, net);

  if(penetrationReached()){
    logEntry(`‚úÇÔ∏è Cut card reached. Next deal will shuffle.`, 0);
    toast("Penetration reached");
  }

  renderAll();

  setTimeout(()=>{
    if(state.phase === "done"){
      state.phase = "idle";
      state.player = [];
      state.dealer = [];
      state.holeHidden = true;
      state.handBet = 0;
      $("#msg").textContent = "Press Deal for the next hand.";
      renderAll();
    }
  }, 650);
}

/* -------------------------------
   Help modal behavior
--------------------------------*/
function openHelp(){
  const b = $("#helpBackdrop");
  b.classList.add("show");
  b.setAttribute("aria-hidden","false");
}
function closeHelp(){
  const b = $("#helpBackdrop");
  b.classList.remove("show");
  b.setAttribute("aria-hidden","true");
}
$("#btnHow").addEventListener("click", openHelp);
$("#btnCloseHelp").addEventListener("click", closeHelp);
$("#helpBackdrop").addEventListener("click", (e)=>{
  if(e.target === $("#helpBackdrop")) closeHelp();
});
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape") closeHelp();
});

/* -------------------------------
   Wire UI
--------------------------------*/
$("#btnSave").addEventListener("click", save);
$("#btnReset").addEventListener("click", resetAll);

$("#btnShuffle").addEventListener("click", ()=>{
  buildNewShoe();
  renderAll();
  toast("Shuffled");
});

$("#btnClearStats").addEventListener("click", ()=>{
  state.checks=0; state.errors=0; state.betChecks=0; state.betErrors=0;
  logEntry("üìä Stats cleared.", 0);
  renderAll();
});

$("#mode").addEventListener("change", (e)=>{
  state.mode = e.target.value;
  if(state.mode === "intermediate"){
    state.showRC = false;
  } else if(state.mode === "advanced"){
    state.showRC = false;
    state.showTC = false;
  }
  renderAll();
});

$("#decks").addEventListener("change", (e)=>{
  state.decks = clampInt(e.target.value, 1);
  buildNewShoe();
  renderAll();
});
$("#pen").addEventListener("change", (e)=>{
  state.pen = clampFloat(e.target.value, 0.1);
  renderAll();
});
$("#speed").addEventListener("change", (e)=>{
  state.speed = clampInt(e.target.value, 0);
  renderAll();
});
$("#showRC").addEventListener("change", (e)=>{
  state.showRC = e.target.checked;
  renderAll();
});
$("#showTC").addEventListener("change", (e)=>{
  state.showTC = e.target.checked;
  renderAll();
});
$("#autoHints").addEventListener("change", (e)=>{
  state.autoHints = e.target.checked;
  renderAll();
});

$("#unit").addEventListener("input", ()=>{
  renderSuggestedBet();
  renderAll();
});
$("#betUnits").addEventListener("change", ()=>{
  renderSuggestedBet();
});

$("#btnDeal").addEventListener("click", dealHand);
$("#btnHit").addEventListener("click", hit);
$("#btnStand").addEventListener("click", stand);
$("#btnDouble").addEventListener("click", doubleDown);
$("#btnFold").addEventListener("click", fold);

$("#btnCountCheck").addEventListener("click", ()=>{
  $("#countFeedback").textContent = "Enter your guess, then Submit Count.";
  toast("Count check");
});
$("#btnSubmitCount").addEventListener("click", gradeCountSubmission);

$("#btnBetCheck").addEventListener("click", gradeBetChoice);

/* -------------------------------
   Hotkeys
--------------------------------*/
document.addEventListener("keydown", (e)=>{
  if(e.target && ["INPUT","SELECT","TEXTAREA"].includes(e.target.tagName)) return;
  const k = e.key.toLowerCase();
  if(k === "d") $("#btnDeal").click();
  if(k === "h") $("#btnHit").click();
  if(k === "s") $("#btnStand").click();
  if(k === "f") $("#btnFold").click();
  if(k === "c") $("#btnCountCheck").click();
  if(k === "b") $("#btnBetCheck").click();
});

/* -------------------------------
   Init
--------------------------------*/
load();
state.mode = state.mode || "beginner";
state.decks = clampInt(state.decks, 1) || 6;
state.pen = clampFloat(state.pen, 0.1) || 0.75;
state.speed = clampInt(state.speed, 0) ?? 420;

if(!Array.isArray(state.shoe) || state.shoe.length === 0){
  buildNewShoe(true);
}
if(state.mode === "advanced"){
  state.showRC = false;
  state.showTC = false;
}
renderAll();
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
  }
</script>
</body>
</html>
